{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - DEANNA{% endblock %}

{% block extra_css %}
<style>
    .modal-overlay {
        background-color: rgba(0, 0, 0, 0.5);
    }
    
    .thumbnail-gallery {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: center;
        margin-top: 1rem;
    }
    
    .thumbnail {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 0.5rem;
        cursor: pointer;
        border: 2px solid transparent;
        transition: border-color 0.3s ease;
    }
    
    .thumbnail:hover {
        border-color: var(--color-accent);
    }
    
    .main-media-container {
        border: 4px solid var(--color-border);
        border-radius: 1rem;
        overflow: hidden;
        margin-bottom: 1rem;
    }
    
    .main-media-container img,
    .main-media-container video {
        width: 100%;
        height: auto;
        border-radius: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-white rounded-xl shadow-md p-6 lg:p-12 flex flex-col lg:flex-row gap-8">
    <!-- Galerie d'images et de vidéos -->
    <div class="lg:w-1/2">
        <div class="main-media-container">
            {% if product.videos.first %}
            <video id="main-product-video" controls autoplay class="w-full h-auto">
                <source src="{{ product.videos.first.video.url }}" type="video/mp4">
                Votre navigateur ne supporte pas la vidéo.
            </video>
            <img id="main-product-image" src="" alt="{{ product.name }}" class="w-full h-auto hidden">
            {% elif product.images.first %}
            <img id="main-product-image" src="{{ product.images.first.image.url }}" alt="{{ product.name }}" class="w-full h-auto">
            <video id="main-product-video" controls class="w-full h-auto hidden"></video>
            {% else %}
            <img id="main-product-image" src="https://placehold.co/800x600/E8E8E8/6C6C6C?text=Image+non+disponible" alt="Image non disponible" class="w-full h-auto">
            <video id="main-product-video" controls class="w-full h-auto hidden"></video>
            {% endif %}
        </div>
        <div class="thumbnail-gallery">
            {% for image in product.images.all %}
            <img src="{{ image.image.url }}" alt="Miniature {{ forloop.counter }}" class="thumbnail" data-media-type="image" data-media-url="{{ image.image.url }}">
            {% endfor %}
            {% for video in product.videos.all %}
            <video class="thumbnail" data-media-type="video" data-media-url="{{ video.video.url }}">
                <source src="{{ video.video.url }}" type="video/mp4">
            </video>
            {% endfor %}
        </div>
    </div>

    <!-- Détails du produit et actions -->
    <div class="lg:w-1/2">
        <h2 class="text-4xl font-bold text-color-primary mb-2">{{ product.name }}</h2>
        <p class="text-sm text-color-text-secondary mb-4">
            Boutique: <a href="#" class="hover:underline">{{ product.shop.merchant.first_name }}</a> |
            Catégorie: <a href="{% url 'products_by_category' category_slug=product.category.slug %}" class="hover:underline">{{ product.category.name }}</a>
            {% if product.subcategory %}
            / <a href="{% url 'products_by_subcategory' category_slug=product.category.slug subcategory_slug=product.subcategory.slug %}" class="hover:underline">{{ product.subcategory.name }}</a>
            {% endif %}
        </p>

        <!-- Affichage de la note moyenne -->
        {% if average_rating %}
        <div class="flex items-center space-x-2 mb-4">
            <div class="flex">
                {% for i in "54321"|make_list %}
                <svg class="h-5 w-5 {% if average_rating >= i|add:0 %}text-yellow-400{% else %}text-gray-300{% endif %}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9.049 2.927c.3-.921 1.631-.921 1.932 0l1.848 5.686a1 1 极0 00.95.691h5.992c.969 0 1.371 1.24.588 1.81l-4.85 3.525a1 1 0 00-.364 1.118l1.848 5.686c极.3.921-.755 1.688-1.54 1.118l-4.85-3.525a1 1 0 00-1.175 0l-4.85 3.525c-.784.57-1.84-.197-1.54-1.118l1.848-5.686a1 1 0 00-.364-1.118L2.57 11.114c-.783-.57-.381-1.81.588-1.81h5.992a1 1 0 00.95-.691l1.848-5.686z" />
                </svg>
                {% endfor %}
            </div>
            <p class="text-sm text-color-text-secondary">({{ average_rating|floatformat:1 }}/5)</p>
        </div>
        {% endif %}
        
        <p class="text-3xl font-bold text-color-accent mb-4">{{ product.price }} CFA</p>
        <p class="text-lg text-color-text mb-6 leading-relaxed">{{ product.description }}</p>
        
        {% if product.stock > 0 %}
        <span class="text-green-600 font-semibold">En stock ({{ product.stock }})</span>
        {% else %}
        <span class="text-red-600 font-semibold">Stock épuisé</span>
        {% endif %}

        <div class="flex space-x-4 mt-6">
            <a href="{% url 'add_to_cart' product.id %}" class="bg-color-accent text-color-primary font-bold py-3 px-6 rounded-full hover:opacity-80 transition-opacity flex-1 text-center">
                Ajouter au panier
            </a>
            <a href="{% url 'start_negotiation' product.id %}" class="bg-gray-200 text-color-text font-bold py-3 px-6 rounded-full hover:bg-gray-300 transition-colors flex-1 text-center">
                Discuter
            </a>
        </div>

        <!-- Section pour les avis -->
        <div class="mt-12">
            <h3 class="text-2xl font-bold text-color-primary mb-4">Avis des clients ({{ reviews|length }})</h3>
            {% if user.is_authenticated and not is_merchant %}
            <!-- Formulaire d'avis -->
            <div class="bg-gray-100 rounded-lg p-6 mb-8">
                <h4 class="text-lg font-semibold mb-4">Laisser un avis</h4>
                <form action="{% url 'add_review' product.id %}" method="post" class="space-y-4">
                    {% csrf_token %}
                    <div>
                        <label for="rating" class="block text-sm font-medium text-color-text-secondary">Note (1-5 étoiles)</label>
                        <select name="rating" id="rating" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-color-accent focus:ring-color-accent">
                            <option value="5">5 - Excellent</option>
                            <option value="4">4 - Très bien</option>
                            <option value="3">3 - Moyen</option>
                            <option value="2">2 - Passable</option>
                            <option value="1">1 - Très mauvais</option>
                        </select>
                    </div>
                    <div>
                        <label for="comment" class="block text-sm font-medium text-color-text-secondary">Commentaire</label>
                        <textarea name="comment" id="comment" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-color-accent focus:ring-color-accent" placeholder="Partagez votre avis sur ce produit..."></textarea>
                    </div>
                    <button type="submit" class="w-full bg-color-primary text-color-bg-light font-bold py-2 px-4 rounded-full hover:bg-opacity-80 transition-opacity">
                        Soumettre l'avis
                    </button>
                </form>
            </div>
            {% elif user.is_authenticated %}
                <p class="text-sm text-color-text-secondary italic mb-4">En tant que commerçant, vous ne pouvez pas laisser d'avis sur ce produit.</p>
            {% else %}
                <p class="text-sm text-color-text-secondary italic mb-4">Connectez-vous pour laisser un avis.</p>
            {% endif %}

            {% for review in reviews %}
            <div class="border-t border-gray-200 pt-6 mt-6">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="font-semibold">{{ review.user.username }}</span>
                    <span class="text-sm text-color-text-secondary">- {{ review.date_created|date:"d M Y" }}</span>
                </div>
                <div class="flex">
                    {% for i in "54321"|make_list %}
                    <svg class="h-5 w-5 {% if review.rating >= i|add:0 %}text-yellow-400{% else %}text-gray-300{% endif %}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9.049 2.927c.3-.921 1.631-.921 1.932 极0l1.848 5.686a1 1 0 00.95.691h5.992极c.969 0 1.371 1.24.588 1.81l-4.85 3.525a1 1 0 00-.364 1.118l1.848 5.686c.3.921-.755 1.688-1.54 1.118l-4.85-3.525a1 1 0 00-1.175 0l-4.85 3.525c-.784.57-1.84-.197-1.54-1.118l1.848-5.686a1 1 0 00-.364-1.118L2.57 11.114c-.783-.极.57-.381-1.81.588-1.81h5.992a1 1 0 00.95-.691l1.848-5.686z" />
                    </svg>
                    {% endfor %}
                </div>
                <p class="mt-2 text-color-text-secondary">{{ review.comment }}</p>
            </div>
            {% empty %}
            <p class="text-sm text-color-text-secondary italic">Soyez le premier à laisser un avis pour ce produit !</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const thumbnails = document.querySelectorAll('.thumbnail');
        const mainImage = document.getElementById('main-product-image');
        const mainVideo = document.getElementById('main-product-video');

        thumbnails.forEach(thumbnail => {
            thumbnail.addEventListener('click', function () {
                const mediaType = this.getAttribute('data-media-type');
                const mediaUrl = this.getAttribute('data-media-url');

                if (mediaType === 'image') {
                    mainImage.src = mediaUrl;
                    mainImage.classList.remove('hidden');
                    mainVideo.classList.add('hidden');
                    mainVideo.pause();
                } else if (mediaType === 'video') {
                    mainVideo.src = mediaUrl;
                    mainImage.classList.add('hidden');
                    mainVideo.classList.remove('hidden');
                    mainVideo.play();
                }
            });
        });

        // Gère l'affichage initial au chargement de la page
        const initialVideo = document.querySelector('.thumbnail[data-media-type="video"]');
        if (initialVideo) {
            mainImage.classList.add('hidden');
            mainVideo.classList.remove('hidden');
            mainVideo.src = initialVideo.getAttribute('data-media-url');
        }
    });
</script>
{% endblock %}