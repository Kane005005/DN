{% extends 'base.html' %}
{% load static %}

{% block title %}Liste des produits - DEANNA{% endblock %}

{% block extra_css %}
<!-- Inclure Glide.js pour le carousel -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@glidejs/glide/dist/css/glide.core.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@glidejs/glide/dist/css/glide.theme.min.css">
<style>
    /* Styles pour le carousel Hero */
    .hero-slide {
        position: relative;
        height: 400px;
        overflow: hidden;
        border-radius: 12px;
    }
    
    .hero-slide img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .hero-content {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
        color: white;
        padding: 2rem;
    }
    
    .hero-title {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .hero-subtitle {
        font-size: 1.1rem;
        margin-bottom: 1rem;
    }
    
    .hero-btn {
        background-color: var(--color-accent);
        color: var(--color-primary);
        padding: 0.75rem 1.5rem;
        border-radius: 9999px;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    
    .hero-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(207, 175, 112, 0.4);
    }

    /* Styles pour le tiroir de filtres mobile */
    .filter-drawer {
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
    }
    
    .filter-drawer.open {
        transform: translateX(0);
    }
    
    .overlay {
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease-in-out;
    }
    
    .overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    /* Styles pour les cartes produits compactes */
    .product-card {
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    .product-card:hover {
        transform: translateY(-3px);
    }
    
    .product-image {
        width: 100%;
        aspect-ratio: 3/4;
        object-fit: cover;
    }
    
    .product-info {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    
    .product-title {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .product-price {
        margin-top: auto;
    }
    
    /* Grille ultra compacte pour l'affichage des produits */
    .product-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }
    
    @media (min-width: 480px) {
        .product-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
    }
    
    @media (min-width: 640px) {
        .product-grid {
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
    }
    
    @media (min-width: 768px) {
        .product-grid {
            grid-template-columns: repeat(5, 1fr);
            gap: 14px;
        }
        
        .hero-slide {
            height: 500px;
        }
        
        .hero-title {
            font-size: 2.5rem;
        }
    }
    
    @media (min-width: 1024极) {
        .product-grid {
            grid-template-columns: repeat(6, 1fr);
            gap: 16px;
        }
    }
    
    @media (min-width: 1280px) {
        .product-grid {
            grid-template-columns: repeat(7, 1fr);
            gap: 18px;
        }
        
        .hero-sl极ide {
            height: 600px;
        }
        
        .hero-title {
            font-size: 3rem;
        }
    }
    
    /* Styles pour les écrans très petits */
    @media (max-width: 360px) {
        .product-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }
        
        .hero-slide {
            height: 300px;
        }
        
        .hero-title {
            font-size: 1.5rem;
        }
        
        .hero-subtitle {
            font-size: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Carousel Hero -->
{% if hero_slides %}
<div class="glide hero-carousel mb-8">
    <div class="glide__track" data-glide-el="track">
        <ul class="glide__slides">
            {% for slide in hero_slides %}
            <li class="glide__slide">
                <div class="hero-slide">
                    <img src="{{ slide.image.url }}" alt="{{ slide.title }}">
                    <div class="hero-content">
                        <h2 class="hero-title">{{ slide.title }}</h2>
                        {% if slide.subtitle %}
                        <p class="hero-subtitle">{{ slide.subtitle }}</p>
                        {% endif %}
                        <a href="{{ slide.get_target_url }}" class="hero-btn">
                            {% if slide.product %}Voir le produit{% else %}Découvrir{% endif %}
                        </a>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    <div class="glide__bullets" data-glide-el="controls[nav]">
        {% for slide in hero_slides %}
        <button class="glide__bullet" data-glide-dir="={{ forloop.counter0 }}"></button>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Bouton pour ouvrir les filtres sur mobile -->
<div class="md:hidden flex justify-center mb-4">
    <button id="filterToggle" class="bg-color-accent text-color-primary font-bold py-2 px-4 rounded-full flex items-center space-x-2 text-xs">
        <i class="fas fa-filter"></i>
        <span>Filtres et tri</span>
    </button>
</div>

<div class="flex flex-col md:flex-row gap-4">
    <!-- Overlay pour mobile -->
    <div id="overlay" class="overlay fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden"></div>

    <!-- Panneau de filtre dans un tiroir sur mobile -->
    <aside id="filterDrawer" class="filter-drawer fixed top-0 left-0 h-full w-4/5 max-w-sm bg-white z-50 overflow-y-auto p-4 md:relative md:transform-none md:w-1/5 md:rounded-lg md:shadow-md md:h-fit md:sticky md:top-4">
        <div class="flex justify-between items-center mb-4 md:hidden">
            <h2 class="text-xl font-bold text-color-primary">Filtres</h2>
            <button id="closeFilters" class="text-color-text-secondary">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <h2 class="text-xl font-bold text-color-primary mb-4 hidden md:block">Filtres</h2>
        
        <form method="GET" action="{% url 'product_list' %}" class="space-y-4">
            <!-- Champ de recherche -->
            <div>
                <label for="q" class="block text-xs font-medium text-color-text-secondary mb-1">Rechercher</label>
                <input type="text" name="q" id="q" placeholder="Nom ou description"
                    value="{{ request.GET.q|default:'' }}"
                    class="w-full px-3 py-1.5 border rounded-md focus:outline-none focus:ring-1 focus:ring-color-accent text-sm">
            </div>

            <!-- Filtre par prix -->
            <div class="space-y-2">
                <h3 class="text-md font-semibold text-color-primary">Prix (CFA)</h3>
                <div>
                    <label for极="min_price" class="block text-xs font-medium text-color-text-secondary mb-1">Min</label>
                    <input type="number" name="min_price" id="min_price" placeholder="0"
                        value="{{ request.GET.min_price|default:'' }}"
                        class="w-full px-3 py-1.5 border rounded-md focus:outline-none focus:ring-1 focus:ring-color-accent text-sm">
                </div>
                <div>
                    <label for="max_price" class="block text-xs font-medium text-color-text-secondary mb-1">Max</label>
                    <input type="number" name="max_price" id="max_price" placeholder="100000"
                        value="{{ request.GET.max_price|default:'' }}"
                        class="w-full px-3 py-1.5 border rounded-md focus:outline-none focus:ring-1 focus:ring-color-accent text-sm">
                </div>
            </div>

            <!-- Filtre par note moyenne -->
            <div class="space-y-1">
                <h3 class="text-md font-semibold text-color-primary">Note minimale</h3>
                {% for i in "54321"|make_list %}
                <div class="flex items-center">
                    <input type="radio" name="min_rating" id="rating-{{ i }}" value="{{ i }}" class="h-3 w-3 text-color-accent focus:ring-color-accent"
                        {% if request.GET.min_rating == i %}checked{% endif %}>
                    <label for="rating-{{ i }}" class="ml-1 flex items-center text-xs text-color-text-secondary">
                        {{ i }} ★ et plus
                    </label>
                </div>
                {% endfor %}
            </div>

            <!-- Catégories (si nécessaires) -->
            {% if categories %}
            <div>
                <h3 class="text-md font-semibold text-color-primary">Catégories</h3>
                <ul class="space-y-1">
                    <li>
                        <a href="{% url 'product_list' %}" class="text-color-text-secondary hover:text-color-accent transition-colors text-xs
                            {% if not current_category %}font-bold{% endif %}">
                            Toutes
                        </a>
                    </li>
                    {% for category in categories %}
                    <li>
                        <a href="{% url 'products_by_category' category_slug=category.slug %}"
                            class="text-color-text-secondary hover:text-color-accent transition-colors text-xs
                            {% if current_category and current_category.slug == category.slug %}font-bold{% endif %}">
                            {{ category.name }}
                        </a>
                        {% if current_category and current_category.slug == category.slug and category.subcategories.all %}
                        <ul class="ml-3 mt-1 space-y-0.5">
                            {% for subcategory in category.subcategories.all %}
                            <li>
                                <a href="{% url 'products_by_subcategory' category_slug=category.slug subcategory_slug=subcategory.slug %}"
                                    class="text-color-text-secondary hover:text-color-accent transition-colors text-xs
                                    {% if current_subcategory and current_subcategory.slug == subcategory.slug %}font-bold{% endif %}">
                                    - {{ subcategory.name }}
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Tri -->
            <div>
                <h3 class="text-md font-semibold text-color-primary mb-1">Trier par</h3>
                <select name="sort_by"
                    class="w-full px-3 py-1.5 border rounded-md focus:outline-none focus:ring-1 focus:ring-color-accent text-sm">
                    <option value="">Pertinence</option>
                    <option value="price_asc" {% if request.GET.sort_by == 'price_asc' %}selected{% endif %}>Prix croissant</option>
                    <option value="price_desc" {% if request.GET.sort_by == 'price_desc' %}selected{% endif %}>Prix décroissant</option>
                    <option value="rating_desc" {% if request.GET.sort_by == 'rating_desc' %}selected{% endif %}>Meilleure note</option>
                </select>
            </div>

            <button type="submit"
                class="w-full bg-color-accent text-color-primary font-bold py-1.5 px-3 rounded-full hover:opacity-80 transition-opacity text-sm">
                Appliquer
            </button>
        </form>
    </aside>

    <!-- Liste des produits -->
    <section class="w-full md:w-4/5">
        <div class="product-grid">
            {% for product in page_obj %}
            <div class="bg-white rounded-lg overflow-hidden product-card shadow-sm">
                <a href="{% url 'product_detail' product.id %}" class="w-full">
                    {% if product.images.first %}
                    <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}"
                        class="product-image">
                    {% else %}
                    <img src="https://placehold.co/400x300/E8E8E8/6C6C6C?text=Image+non+disponible"
                        alt="Image non disponible" class="product-image">
                    {% endif %}
                </a>
                <div class="p-2 product-info">
                    <a href="{% url 'product_detail' product.id %}" class="w-full">
                        <h3 class="text-xs font-semibold text-color-text mb-1 product-title leading-tight">{{ product.name }}</h3>
                    </a>
                    <p class="text-xs text-color-text-secondary mb-1 product-price font-bold">{{ product.price }} CFA</p>
                    {% if product.get_average_rating > 0 %}
                    <p class="text-xs text-yellow-500">★ {{ product.get_average_rating|floatformat:1 }}</p>
                    {% endif %}
                    <a href="{% url 'add_to_cart' product.id %}"
                        class="mt-1 inline-block bg-color-accent text-color-primary px-2 py-1 rounded-full text-xs font-semibold hover:bg-color-accent-darker transition-colors w-full text-center">
                        + Panier
                    </a>
                </div>
            </div>
            {% empty %}
            <div class="col-span-full text-center py-6 bg-white rounded-lg shadow-sm">
                <p class="text-color-text-secondary text-sm">Aucun produit ne correspond à votre recherche.</p>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        <nav class="flex justify-center mt-6">
            <ul class="flex items-center space-x-1">
                {% if page_obj.has_previous %}
                <li>
                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.min_price %}&min_price={{ request.GET.min_price }}{% endif %}{% if request.GET.max_price %}&max_price={{ request.GET.max_price }}{% endif %}{% if request.GET.min_rating %}&min_rating={{ request.GET.min_rating }}{% endif %}{% if request.GET.sort_by %}&sort_by={{ request.GET.sort_by }}{% endif %}"
                        class="px-2 py-1 leading-tight text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-100 hover:text-gray-700 text-xs">Préc.</a>
                </li>
                {% endif %}
                <li class="px-2 py-1 leading-tight text-color-primary bg-color-accent border border-color-accent rounded-md text-xs">
                    {{ page_obj.number }}
                </li>
                {% if page_obj.has_next %}
                <li>
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.min_price %}&min_price={{ request.GET.min_price }}{% endif %}{% if request.GET.max_price %}&max_price={{ request.GET.max_price }}{% endif %}{% if request.GET.min_rating %}&min_rating={{ request.GET.min_rating }}{% endif %}{% if request.GET.sort_by %}&sort_by={{ request.GET.sort_by }}{% endif %}"
                        class="px-2 py-1 leading-tight text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-100 hover:text-gray-700 text-xs">Suiv.</a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<!-- Scripts pour Glide.js -->
<script src="https://cdn.jsdelivr.net/npm/@glidejs/glide"></script>
<script>
    // Initialisation du carousel Hero
    {% if hero_slides %}
    new Glide('.hero-carousel', {
        type: 'carousel',
        autoplay: 5000,
        hoverpause: true,
        perView: 1,
        animationDuration: 800
    }).mount();
    {% endif %}

    // Gestion du tiroir de filtres sur mobile
    const filterToggle = document.getElementById('filterToggle');
    const filterDrawer = document.getElementById('filterDrawer');
    const closeFilters = document.getElementById('closeFilters');
    const overlay = document.getElementById('overlay');
    
    function toggleFilters() {
        filterDrawer.classList.toggle('open');
        overlay.classList.toggle('active');
        document.body.style.overflow = filterDrawer.classList.contains('open') ? 'hidden' : '';
    }
    
    filterToggle.addEventListener('click', toggleFilters);
    closeFilters.addEventListener('click', toggleFilters);
    overlay.addEventListener('click', toggleFilters);
    
    // Fermer les filtres si on clique sur un lien de catégorie en mode mobile
    const categoryLinks = document.querySelectorAll('a[href*="category"]');
    categoryLinks.forEach(link => {
        link.addEventListener('click', function() {
            if (window.innerWidth < 768) {
                toggleFilters();
            }
        });
    });
</script>
{% endblock %}